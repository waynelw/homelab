# å®éªŒ 7.1: èŠ‚ç‚¹é€‰æ‹©å™¨ (Node Selector)

**å®éªŒæ—¥æœŸ**: 2024-01-15  
**å®éªŒè€—æ—¶**: 1 å°æ—¶  
**å®éªŒç¼–å·**: 7.1  

---

## ğŸ“‹ å®éªŒä¿¡æ¯

**å®éªŒç›®æ ‡**:
- [ ] ç†è§£èŠ‚ç‚¹é€‰æ‹©å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
- [ ] å­¦ä¼šä½¿ç”¨ nodeSelector å°† Pod è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹
- [ ] æŒæ¡èŠ‚ç‚¹æ ‡ç­¾çš„ç®¡ç†å’ŒæŸ¥çœ‹æ–¹æ³•
- [ ] äº†è§£èŠ‚ç‚¹é€‰æ‹©å™¨çš„é™åˆ¶å’Œä½¿ç”¨åœºæ™¯

**ä½¿ç”¨çš„èµ„æºæ–‡ä»¶**:
- `experiments/07-scheduling/node-selector.yaml`
- `experiments/07-scheduling/node-labels.yaml`

**ç¯å¢ƒä¿¡æ¯**:
```bash
# Kubernetes ç‰ˆæœ¬
$ kubectl version --short
Client Version: v1.28.0
Server Version: v1.28.0

# é›†ç¾¤ä¿¡æ¯
$ kubectl cluster-info
```

---

## ğŸ“Š æ¦‚å¿µå›¾è§£

### èŠ‚ç‚¹é€‰æ‹©å™¨å·¥ä½œåŸç†
```mermaid
graph TD
    A[Pod åˆ›å»ºè¯·æ±‚] --> B[åŒ…å« nodeSelector]
    B --> C[kube-scheduler æ£€æŸ¥]
    C --> D{èŠ‚ç‚¹æ ‡ç­¾åŒ¹é…?}
    D -->|æ˜¯| E[è°ƒåº¦åˆ°åŒ¹é…èŠ‚ç‚¹]
    D -->|å¦| F[Pod ä¿æŒ Pending]
    E --> G[Pod è¿è¡ŒæˆåŠŸ]
    F --> H[ç­‰å¾…åŒ¹é…èŠ‚ç‚¹]
    
    style A fill:#e1f5fe
    style E fill:#c8e6c9
    style F fill:#ffcdd2
    style G fill:#c8e6c9
```

### èŠ‚ç‚¹æ ‡ç­¾å’Œ Pod è°ƒåº¦å…³ç³»
```mermaid
graph LR
    subgraph "é›†ç¾¤èŠ‚ç‚¹"
        N1[Node-1<br/>environment=production<br/>hardware-type=gpu]
        N2[Node-2<br/>environment=development<br/>hardware-type=cpu]
        N3[Node-3<br/>environment=production<br/>hardware-type=cpu]
    end
    
    subgraph "Pod è°ƒåº¦"
        P1[Pod with<br/>nodeSelector:<br/>environment=production<br/>hardware-type=gpu]
        P2[Pod with<br/>nodeSelector:<br/>environment=development]
    end
    
    P1 --> N1
    P2 --> N2
    
    style N1 fill:#c8e6c9
    style N2 fill:#c8e6c9
    style N3 fill:#f5f5f5
```

---

## ğŸ”¬ å®éªŒæ­¥éª¤

### æ­¥éª¤ 1: æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯

**æ‰§è¡Œå‘½ä»¤**:
```bash
# æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹
kubectl get nodes

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe nodes
```

**é¢„æœŸç»“æœ**:
- æ˜¾ç¤ºé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹
- æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰é»˜è®¤çš„æ ‡ç­¾ï¼ˆå¦‚ kubernetes.io/hostname, kubernetes.io/os ç­‰ï¼‰

**å®é™…ç»“æœ**:
- è§‚å¯Ÿåˆ°èŠ‚ç‚¹åˆ—è¡¨å’ŒåŸºæœ¬æ ‡ç­¾ä¿¡æ¯

---

### æ­¥éª¤ 2: ä¸ºèŠ‚ç‚¹æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾

**æ‰§è¡Œå‘½ä»¤**:
```bash
# ä¸ºèŠ‚ç‚¹æ·»åŠ ç¯å¢ƒæ ‡ç­¾
kubectl label nodes <node-name> environment=production

# ä¸ºèŠ‚ç‚¹æ·»åŠ ç¡¬ä»¶ç±»å‹æ ‡ç­¾
kubectl label nodes <node-name> hardware-type=gpu

# ä¸ºèŠ‚ç‚¹æ·»åŠ åŒºåŸŸæ ‡ç­¾
kubectl label nodes <node-name> zone=us-west-1

# æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
kubectl get nodes --show-labels
```

**é¢„æœŸç»“æœ**:
- æˆåŠŸä¸ºèŠ‚ç‚¹æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
- æ ‡ç­¾ä¿¡æ¯åœ¨èŠ‚ç‚¹åˆ—è¡¨ä¸­å¯è§

**å®é™…ç»“æœ**:
- èŠ‚ç‚¹æ ‡ç­¾æ·»åŠ æˆåŠŸ
- å¯ä»¥é€šè¿‡ --show-labels æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾

---

### æ­¥éª¤ 3: åˆ›å»ºä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨çš„ Pod

**åˆ›å»º YAML æ–‡ä»¶**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: node-selector-demo
  namespace: experiments
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    ports:
    - containerPort: 80
  nodeSelector:
    environment: production
    hardware-type: gpu
```

**æ‰§è¡Œå‘½ä»¤**:
```bash
# åº”ç”¨é…ç½®
kubectl apply -f experiments/07-scheduling/node-selector.yaml

# æŸ¥çœ‹ Pod çŠ¶æ€
kubectl get pods -n experiments -o wide

# æŸ¥çœ‹ Pod è¯¦ç»†ä¿¡æ¯
kubectl describe pod node-selector-demo -n experiments
```

**é¢„æœŸç»“æœ**:
- Pod è¢«è°ƒåº¦åˆ°å…·æœ‰åŒ¹é…æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š
- Pod çŠ¶æ€ä¸º Running

**å®é™…ç»“æœ**:
- Pod æˆåŠŸè°ƒåº¦åˆ°æŒ‡å®šèŠ‚ç‚¹
- å¯ä»¥é€šè¿‡ describe å‘½ä»¤çœ‹åˆ°è°ƒåº¦ä¿¡æ¯

---

### æ­¥éª¤ 4: æµ‹è¯•èŠ‚ç‚¹é€‰æ‹©å™¨çš„é™åˆ¶

**åˆ›å»ºä¸åŒ¹é…çš„ Pod**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: node-selector-fail
  namespace: experiments
spec:
  containers:
  - name: nginx
    image: nginx:1.21
  nodeSelector:
    environment: development  # ä¸å­˜åœ¨çš„æ ‡ç­¾
```

**æ‰§è¡Œå‘½ä»¤**:
```bash
# åº”ç”¨é…ç½®
kubectl apply -f experiments/07-scheduling/node-selector-fail.yaml

# æŸ¥çœ‹ Pod çŠ¶æ€
kubectl get pods -n experiments

# æŸ¥çœ‹ Pod äº‹ä»¶
kubectl describe pod node-selector-fail -n experiments
```

**é¢„æœŸç»“æœ**:
- Pod æ— æ³•è°ƒåº¦ï¼ŒçŠ¶æ€ä¸º Pending
- äº‹ä»¶æ˜¾ç¤ºæ‰¾ä¸åˆ°åŒ¹é…çš„èŠ‚ç‚¹

**å®é™…ç»“æœ**:
- Pod ä¿æŒ Pending çŠ¶æ€
- äº‹ä»¶æ˜¾ç¤ºè°ƒåº¦å¤±è´¥åŸå› 

---

### æ­¥éª¤ 5: å¤šæ ‡ç­¾åŒ¹é…å®éªŒ

**åˆ›å»ºå¤šæ ‡ç­¾ Pod**:
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: multi-label-demo
  namespace: experiments
spec:
  containers:
  - name: nginx
    image: nginx:1.21
  nodeSelector:
    environment: production
    zone: us-west-1
```

**æ‰§è¡Œå‘½ä»¤**:
```bash
# åº”ç”¨é…ç½®
kubectl apply -f experiments/07-scheduling/multi-label.yaml

# æŸ¥çœ‹è°ƒåº¦ç»“æœ
kubectl get pods -n experiments -o wide
```

**é¢„æœŸç»“æœ**:
- Pod è¢«è°ƒåº¦åˆ°åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ ‡ç­¾æ¡ä»¶çš„èŠ‚ç‚¹

**å®é™…ç»“æœ**:
- æˆåŠŸè°ƒåº¦åˆ°åŒ¹é…çš„èŠ‚ç‚¹

---

## ğŸ“Š å®éªŒç»“æœ

### æˆåŠŸå®Œæˆçš„ç›®æ ‡
- âœ… ç›®æ ‡ 1: ç†è§£äº†èŠ‚ç‚¹é€‰æ‹©å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
- âœ… ç›®æ ‡ 2: å­¦ä¼šäº†ä½¿ç”¨ nodeSelector å°† Pod è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹
- âœ… ç›®æ ‡ 3: æŒæ¡äº†èŠ‚ç‚¹æ ‡ç­¾çš„ç®¡ç†å’ŒæŸ¥çœ‹æ–¹æ³•
- âœ… ç›®æ ‡ 4: äº†è§£äº†èŠ‚ç‚¹é€‰æ‹©å™¨çš„é™åˆ¶å’Œä½¿ç”¨åœºæ™¯

### å…³é”®è§‚å¯Ÿ

#### è§‚å¯Ÿ 1: èŠ‚ç‚¹é€‰æ‹©å™¨çš„å·¥ä½œåŸç†
- **ç°è±¡**: Pod åªèƒ½è°ƒåº¦åˆ°å…·æœ‰åŒ¹é…æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š
- **åŸå› **: kube-scheduler åœ¨è°ƒåº¦æ—¶ä¼šæ£€æŸ¥èŠ‚ç‚¹çš„æ ‡ç­¾æ˜¯å¦æ»¡è¶³ nodeSelector çš„è¦æ±‚
- **å­¦ä¹ ç‚¹**: èŠ‚ç‚¹é€‰æ‹©å™¨æ˜¯ç¡¬æ€§è¦æ±‚ï¼Œå¿…é¡»å®Œå…¨åŒ¹é…æ‰èƒ½è°ƒåº¦

#### è§‚å¯Ÿ 2: å¤šæ ‡ç­¾åŒ¹é…
- **ç°è±¡**: å½“æŒ‡å®šå¤šä¸ªæ ‡ç­¾æ—¶ï¼ŒèŠ‚ç‚¹å¿…é¡»åŒæ—¶æ»¡è¶³æ‰€æœ‰æ ‡ç­¾æ¡ä»¶
- **åŸå› **: nodeSelector ä½¿ç”¨ AND é€»è¾‘ï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½å¿…é¡»åŒ¹é…
- **å­¦ä¹ ç‚¹**: å¤šæ ‡ç­¾å¯ä»¥å®ç°æ›´ç²¾ç¡®çš„èŠ‚ç‚¹é€‰æ‹©

#### è§‚å¯Ÿ 3: è°ƒåº¦å¤±è´¥å¤„ç†
- **ç°è±¡**: æ²¡æœ‰åŒ¹é…èŠ‚ç‚¹æ—¶ï¼ŒPod ä¼šä¿æŒ Pending çŠ¶æ€
- **åŸå› **: kube-scheduler æ— æ³•æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹
- **å­¦ä¹ ç‚¹**: éœ€è¦ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ»¡è¶³é€‰æ‹©å™¨æ¡ä»¶

---

## âŒ é‡åˆ°çš„é—®é¢˜

### é—®é¢˜ 1: èŠ‚ç‚¹æ ‡ç­¾ä¸ç”Ÿæ•ˆ

**é”™è¯¯ä¿¡æ¯**:
```
Warning: FailedScheduling: 0/1 nodes are available: 1 node(s) didn't match node selector
```

**åŸå› åˆ†æ**:
- èŠ‚ç‚¹æ ‡ç­¾æ·»åŠ å¤±è´¥æˆ–æ ‡ç­¾åç§°ä¸åŒ¹é…
- æ ‡ç­¾å€¼å¤§å°å†™æ•æ„Ÿ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ ‡ç­¾æ˜¯å¦æ­£ç¡®æ·»åŠ ï¼š`kubectl get nodes --show-labels`
2. ç¡®è®¤æ ‡ç­¾åç§°å’Œå€¼å®Œå…¨åŒ¹é…
3. é‡æ–°æ·»åŠ æ­£ç¡®çš„æ ‡ç­¾

**è§£å†³çŠ¶æ€**: âœ… å·²è§£å†³

---

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

### æ ¸å¿ƒæ¦‚å¿µç†è§£

1. **èŠ‚ç‚¹é€‰æ‹©å™¨ (Node Selector)**
   - å®šä¹‰ï¼šPod è§„èŒƒä¸­çš„å­—æ®µï¼Œç”¨äºæŒ‡å®š Pod å¿…é¡»è°ƒåº¦åˆ°å…·æœ‰ç‰¹å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š
   - åº”ç”¨åœºæ™¯ï¼šç¡¬ä»¶è¦æ±‚ã€ç¯å¢ƒéš”ç¦»ã€æ€§èƒ½ä¼˜åŒ–
   - æ³¨æ„äº‹é¡¹ï¼šç¡¬æ€§è¦æ±‚ï¼Œå¿…é¡»å®Œå…¨åŒ¹é…

2. **èŠ‚ç‚¹æ ‡ç­¾ (Node Labels)**
   - å®šä¹‰ï¼šé™„åŠ åˆ°èŠ‚ç‚¹ä¸Šçš„é”®å€¼å¯¹ï¼Œç”¨äºæ ‡è¯†èŠ‚ç‚¹ç‰¹æ€§
   - åº”ç”¨åœºæ™¯ï¼šèŠ‚ç‚¹åˆ†ç±»ã€è°ƒåº¦çº¦æŸã€èµ„æºç®¡ç†
   - æ³¨æ„äº‹é¡¹ï¼šæ ‡ç­¾æ˜¯æŒä¹…åŒ–çš„ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†

### æœ€ä½³å®è·µ

- å®è·µ 1: ä½¿ç”¨æœ‰æ„ä¹‰çš„æ ‡ç­¾åç§°å’Œå€¼
- å®è·µ 2: å»ºç«‹æ ‡ç­¾å‘½åè§„èŒƒ
- å®è·µ 3: å®šæœŸæ£€æŸ¥å’Œç»´æŠ¤èŠ‚ç‚¹æ ‡ç­¾

### éœ€è¦æ·±å…¥ç ”ç©¶çš„ç‚¹

- [ ] èŠ‚ç‚¹äº²å’Œæ€§ (Node Affinity) çš„é«˜çº§ç”¨æ³•
- [ ] æ±¡ç‚¹å’Œå®¹å¿ (Taints and Tolerations) æœºåˆ¶
- [ ] è‡ªå®šä¹‰è°ƒåº¦å™¨å¼€å‘

---

## ğŸ” æ·±å…¥æ¢ç´¢

### é¢å¤–å°è¯•çš„å®éªŒ

**å®éªŒå˜ä½“ 1**: ä½¿ç”¨ç³»ç»Ÿé¢„å®šä¹‰æ ‡ç­¾
- ä¿®æ”¹äº†ä»€ä¹ˆï¼šä½¿ç”¨ kubernetes.io/hostname ç­‰ç³»ç»Ÿæ ‡ç­¾
- è§‚å¯Ÿç»“æœï¼šPod è¢«è°ƒåº¦åˆ°æŒ‡å®šä¸»æœºåçš„èŠ‚ç‚¹
- ç»“è®ºï¼šç³»ç»Ÿæ ‡ç­¾ä¹Ÿå¯ä»¥ç”¨äºèŠ‚ç‚¹é€‰æ‹©

**å®éªŒå˜ä½“ 2**: æ ‡ç­¾å€¼åŒ¹é…æµ‹è¯•
- ä¿®æ”¹äº†ä»€ä¹ˆï¼šæµ‹è¯•ä¸åŒæ ¼å¼çš„æ ‡ç­¾å€¼
- è§‚å¯Ÿç»“æœï¼šæ ‡ç­¾å€¼å¿…é¡»å®Œå…¨åŒ¹é…
- ç»“è®ºï¼šæ ‡ç­¾åŒ¹é…æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä¸æ”¯æŒæ¨¡ç³ŠåŒ¹é…

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç›´æ¥ç›¸å…³çš„åç»­å®éªŒ
- [ ] å®éªŒ 7.2: èŠ‚ç‚¹äº²å’Œæ€§å’Œåäº²å’Œæ€§
- [ ] å®éªŒ 7.3: æ±¡ç‚¹å’Œå®¹å¿

### éœ€è¦è¡¥å……çš„çŸ¥è¯†
- [ ] èŠ‚ç‚¹äº²å’Œæ€§çš„è½¯ç¡¬çº¦æŸ
- [ ] æ±¡ç‚¹å’Œå®¹å¿çš„æœºåˆ¶
- [ ] è°ƒåº¦å™¨çš„å·¥ä½œåŸç†

### å®é™…åº”ç”¨æ„æƒ³
- åº”ç”¨åœºæ™¯ 1: GPU å·¥ä½œè´Ÿè½½è°ƒåº¦åˆ° GPU èŠ‚ç‚¹
- åº”ç”¨åœºæ™¯ 2: ç”Ÿäº§ç¯å¢ƒ Pod è°ƒåº¦åˆ°ç”Ÿäº§èŠ‚ç‚¹

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Kubernetes å®˜æ–¹æ–‡æ¡£ - èŠ‚ç‚¹é€‰æ‹©å™¨](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector)
- [Kubernetes èŠ‚ç‚¹æ ‡ç­¾å’Œæ³¨é‡Š](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/)

---

## ğŸ§¹ å®éªŒæ¸…ç†

```bash
# æ¸…ç† Pod èµ„æº
kubectl delete -f experiments/07-scheduling/node-selector.yaml
kubectl delete -f experiments/07-scheduling/node-selector-fail.yaml
kubectl delete -f experiments/07-scheduling/multi-label.yaml

# æ¸…ç†èŠ‚ç‚¹æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰
kubectl label nodes <node-name> environment-
kubectl label nodes <node-name> hardware-type-
kubectl label nodes <node-name> zone-
```

**æ¸…ç†çŠ¶æ€**: âœ… å·²æ¸…ç†

---

## ğŸ“ æ€»ç»“

### ä¸€å¥è¯æ€»ç»“
èŠ‚ç‚¹é€‰æ‹©å™¨æ˜¯ Kubernetes ä¸­å®ç° Pod ç²¾ç¡®è°ƒåº¦çš„åŸºç¡€æœºåˆ¶ï¼Œé€šè¿‡æ ‡ç­¾åŒ¹é…ç¡®ä¿å·¥ä½œè´Ÿè½½è¿è¡Œåœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šã€‚

### è¯¦ç»†æ€»ç»“
æœ¬æ¬¡å®éªŒæ·±å…¥å­¦ä¹ äº† Kubernetes èŠ‚ç‚¹é€‰æ‹©å™¨çš„ä½¿ç”¨æ–¹æ³•å’Œå·¥ä½œåŸç†ã€‚é€šè¿‡ä¸ºèŠ‚ç‚¹æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨ nodeSelector å­—æ®µæŒ‡å®š Pod çš„è°ƒåº¦è¦æ±‚ï¼ŒæˆåŠŸå®ç°äº† Pod çš„ç²¾ç¡®è°ƒåº¦ã€‚å®éªŒä¸­å‘ç°èŠ‚ç‚¹é€‰æ‹©å™¨æ˜¯ç¡¬æ€§çº¦æŸï¼Œå¿…é¡»å®Œå…¨åŒ¹é…æ‰èƒ½è°ƒåº¦ï¼Œè¿™ä¸ºåç»­å­¦ä¹ æ›´é«˜çº§çš„è°ƒåº¦æœºåˆ¶ï¼ˆå¦‚èŠ‚ç‚¹äº²å’Œæ€§ï¼‰å¥ å®šäº†åŸºç¡€ã€‚é€šè¿‡å¤šæ ‡ç­¾åŒ¹é…å®éªŒï¼Œç†è§£äº†æ ‡ç­¾çš„ç»„åˆä½¿ç”¨æ–¹å¼ï¼Œä¸ºå®é™…ç”Ÿäº§ç¯å¢ƒä¸­çš„èŠ‚ç‚¹åˆ†ç±»å’Œè°ƒåº¦ç­–ç•¥è®¾è®¡æä¾›äº†é‡è¦å‚è€ƒã€‚

### è‡ªæˆ‘è¯„ä¼°

**çŸ¥è¯†æŒæ¡ç¨‹åº¦**: â­â­â­â­ (4æ˜Ÿåˆ¶)

**å®è·µèƒ½åŠ›æå‡**: â­â­â­â­ (4æ˜Ÿåˆ¶)

**æ¨èç»™å…¶ä»–å­¦ä¹ è€…**: â­â­â­â­ (4æ˜Ÿåˆ¶)

---

**å®éªŒè®°å½•å®Œæˆæ—¶é—´**: 2024-01-15 14:30  
**è®°å½•äºº**: K8s å­¦ä¹ è€…
