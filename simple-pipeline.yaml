---
# ç®€åŒ–çš„Git Clone Task
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone-simple
  namespace: demo-app
spec:
  params:
    - name: url
      type: string
      description: Git repository URL
    - name: revision
      type: string
      description: Git revision
      default: main
  workspaces:
    - name: output
      description: The git repo will be cloned onto this workspace
  steps:
    - name: clone
      image: alpine/git:latest
      script: |
        #!/bin/sh
        set -e
        echo "Cloning $(params.url) at revision $(params.revision)"
        git clone $(params.url) $(workspaces.output.path)/source
        cd $(workspaces.output.path)/source
        git checkout $(params.revision)
        echo "Clone completed successfully"
        ls -la $(workspaces.output.path)/source

---
# ç®€åŒ–çš„æ„å»ºTask
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-simple
  namespace: demo-app
spec:
  params:
    - name: image
      type: string
      description: Image name to build
  workspaces:
    - name: source
      description: Source code workspace
  steps:
    - name: build
      image: docker:dind
      script: |
        #!/bin/sh
        set -e
        echo "Building image $(params.image)"
        echo "Source files:"
        ls -la $(workspaces.source.path)/source
        
        # æ¨¡æ‹Ÿæ„å»ºè¿‡ç¨‹
        echo "ğŸ”¨ Building Docker image..."
        echo "ğŸ“¦ Image $(params.image) built successfully"
        echo "ğŸš€ Pushing to registry..."
        echo "âœ… Push completed"

---
# ç®€åŒ–çš„éƒ¨ç½²Task  
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-simple
  namespace: demo-app
spec:
  params:
    - name: image
      type: string
      description: Image to deploy
  steps:
    - name: deploy
      image: bitnami/kubectl:latest
      script: |
        #!/bin/bash
        set -e
        echo "ğŸš€ Deploying image $(params.image)"
        
        # æ£€æŸ¥å½“å‰deployment
        echo "Current deployment status:"
        kubectl get deployment demo-app -n demo-app -o wide || echo "Deployment not found"
        
        # æ¨¡æ‹Ÿéƒ¨ç½²æ›´æ–°
        echo "ğŸ“ Updating deployment with new image..."
        echo "â³ Rolling out new version..."
        echo "âœ… Deployment completed successfully!"
        
        # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
        kubectl get pods -n demo-app

---
# ç®€åŒ–çš„Pipeline
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: demo-simple-pipeline
  namespace: demo-app
spec:
  params:
    - name: git-url
      type: string
      description: Git repository URL
    - name: git-revision
      type: string
      description: Git revision
      default: main
    - name: image-name
      type: string
      description: Image name with registry

  workspaces:
    - name: shared-data
      description: Shared workspace for pipeline tasks

  tasks:
    - name: fetch-source
      taskRef:
        name: git-clone-simple
      workspaces:
        - name: output
          workspace: shared-data
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)

    - name: build-image
      taskRef:
        name: build-simple
      runAfter:
        - fetch-source
      workspaces:
        - name: source
          workspace: shared-data
      params:
        - name: image
          value: $(params.image-name)

    - name: deploy-app
      taskRef:
        name: deploy-simple
      runAfter:
        - build-image
      params:
        - name: image
          value: $(params.image-name)
